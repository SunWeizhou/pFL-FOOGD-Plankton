# pFL-FOOGD 项目工作记录 - 2025年12月9日

## 项目概述
pFL-FOOGD (Personalized Federated Learning with Feature-Oriented Out-of-Distribution Generalization and Detection) 是一个用于海洋浮游生物图像识别的联邦学习框架，结合了FedRoD和FOOGD技术。

## 当前状态

### 已完成的工作
1. **代码优化与修复**
   - 修复了数据泄漏问题（验证无数据泄漏）
   - 优化了KSD损失计算（添加维度归一化）
   - 改进了FOOGD模块的训练稳定性

2. **实验脚本重构**
   - 将原来的8个实验拆分为两个并行脚本
   - 创建了GPU并行运行系统
   - 优化了日志记录和实验管理

3. **数据集准备**
   - 完成了Plankton_OOD_Dataset的数据划分
   - 建立了严格的ID/Near-OOD/Far-OOD类别定义
   - 实现了非IID数据分区（Dirichlet分布）

### 当前实验配置

#### GPU 0 (4个实验)
- `alpha0.1_with_foogd` - 极端异质性 (With FOOGD)
- `alpha0.1_no_foogd`   - 极端异质性 (Baseline)
- `alpha0.5_with_foogd` - 真实强异质性 (With FOOGD)
- `alpha0.5_no_foogd`   - 真实强异质性 (Baseline)

#### GPU 1 (2个实验)
- `alpha5.0_with_foogd` - 中等异质性 (With FOOGD)
- `alpha5.0_no_foogd`   - 中等异质性 (Baseline)

### 实验参数
- **模型**: DenseNet-121
- **客户端数量**: 5
- **通信轮数**: 100
- **本地训练轮数**: 3
- **批次大小**: 64
- **图像尺寸**: 299×299
- **随机种子**: 2025（确保数据划分一致性）

## 文件结构

### 核心代码文件
- `train_federated.py` - 主训练脚本
- `models.py` - 神经网络模型定义
- `client.py` - 联邦学习客户端
- `server.py` - 联邦学习服务器
- `data_utils.py` - 数据加载和分区
- `eval_utils.py` - 评估工具

### 实验管理脚本
- `run_experiments_gpu0.sh` - GPU 0实验脚本
- `run_experiments_gpu1.sh` - GPU 1实验脚本
- `run_experiments_parallel.sh` - 并行启动脚本
- `run_experiments.sh` - 原始完整实验脚本

### 数据集相关
- `split_dataset.py` - 数据集划分脚本
- `Plankton_OOD_Dataset/` - 浮游生物OOD数据集
- `DYB-PlanktonNet/` - 原始DYB浮游生物数据集

### 测试和验证
- `test_pipeline.py` - 系统测试
- `test_foogd_pipeline.py` - FOOGD模块测试
- `verify_leakage.py` - 数据泄漏验证
- `check_overlap.py` - 数据重叠检查

### 分析和可视化
- `visualize_experiments.py` - 实验结果可视化
- `experiment_analysis_summary.md` - 实验分析总结
- `visualizations/` - 可视化结果目录
- `experiments/` - 实验输出目录

### 文档
- `CLAUDE.md` - 项目详细说明
- `README.md` - 项目主README
- `FOOGD的修正.md` - FOOGD模块修正记录
- `新项目工作文档.MD` - 项目工作文档

## 运行指南

### 环境设置
```bash
pip install -r requirements.txt
```

### 数据集准备
```bash
python split_dataset.py
```

### 并行运行所有实验
```bash
bash run_experiments_parallel.sh
```

### 单独运行GPU实验
```bash
# GPU 0实验
./run_experiments_gpu0.sh

# GPU 1实验
./run_experiments_gpu1.sh
```

### 监控实验进度
```bash
# 查看GPU 0日志
tail -f logs/gpu0_parallel.log

# 查看GPU 1日志
tail -f logs/gpu1_parallel.log

# 查看所有实验日志
ls -la logs/*.log
```

## 关键改进点

### 1. 数据泄漏修复
- 验证了训练集和测试集之间无数据重叠
- 确保了ID、Near-OOD、Far-OOD类别的严格分离

### 2. FOOGD模块优化
- KSD损失添加了维度归一化（除以特征维度）
- 调整了目标lambda值（ksd=0.01, sm=0.1）
- 改进了训练稳定性和收敛性

### 3. 性能优化
- 预生成客户端测试加载器，避免重复创建
- 使用persistent_workers=True提高数据加载效率
- 优化了KSD计算的内存使用

### 4. 实验管理
- 创建了并行实验运行系统
- 完善的日志记录和错误处理
- 实验配置的集中管理

## 下一步计划

### 短期目标
1. 完成当前6组实验的运行
2. 分析实验结果，比较FOOGD的效果
3. 优化模型超参数

### 中期目标
1. 扩展更多alpha值的实验
2. 测试不同模型架构（DenseNet-169等）
3. 增加客户端数量和通信轮数

### 长期目标
1. 论文撰写和结果整理
2. 代码开源和文档完善
3. 扩展到其他数据集和应用场景

## 注意事项

1. **显存要求**: 建议使用NVIDIA RTX 3060（6GB VRAM）或更高
2. **数据集路径**: 确保`Plankton_OOD_Dataset`目录存在且数据完整
3. **日志监控**: 定期检查日志文件，确保实验正常运行
4. **实验重复**: 使用固定随机种子确保结果可重复

## 联系信息

- **项目负责人**: [你的姓名]
- **创建日期**: 2025年12月9日
- **最后更新**: 2025年12月9日

---

*此文档记录了pFL-FOOGD项目在2025年12月9日的状态和进展。*